---
applyTo: "**/*.ts"
description: 'A set of core principles to guide the behavior of all AI agents in the AI-Volt project.'
---

# 🤖 AI-Volt TypeScript Development Instructions
## Advanced Multi-Agent System with Voltagent Framework

### 🏗️ **CRITICAL WORKFLOW MANDATE**
After EVERY file modification or code generation, you MUST leverage error checking for thorough validation. Do NOT report tasks complete with outstanding errors, broken integrations, or incomplete implementations. Ensure full integration and functionality verification.

### 📋 **PROJECT CONTEXT & ARCHITECTURE**

This is **AI-Volt** - a sophisticated multi-agent orchestration platform built with:
- **Framework**: [Voltagent](https://voltagent.dev/docs/) (`@voltagent/core` v0.1.30, `@voltagent/vercel-ai` v0.1.9, `@voltagent/supabase` v0.1.7)
- **AI Provider**: Vercel AI SDK with Google Generative AI (`@ai-sdk/google` v1.2.19, `ai` v4.3.16) - **Gemini 2.5 Flash Preview** (gemini-2.5-flash-preview-05-20)
- **Architecture**: Supervisor/Worker pattern with specialized agent delegation using `subAgents` property
- **Database**: LibSQL/Turso for agent memory storage, Supabase (`@supabase/supabase-js` v2.50.0) and Pinecone (`@pinecone-database/pinecone` v6.1.0) for vector storage
- **Monitoring**: OpenTelemetry (`@opentelemetry/auto-instrumentations-node` v0.60.0, `@opentelemetry/sdk-node` v0.202.0) + Langfuse via Langchain (`langchain` v0.3.27, `langsmith` v0.3.30)
- **Language**: TypeScript v5.8.3 with strict type safety
- **Package Management**: **npm** exclusively (NEVER yarn or pnpm)
- **Key Dependencies**:
    - Zod v3.25.56 for runtime validation
    - Playwright v1.52.0 for browser automation
    - Simple-Git v3.28.0 and Isomorphic-Git v1.30.2 for Git operations
    - Cheerio v1.0.0 for web scraping
    - @xenova/transformers v2.17.2 for local embeddings (all-MiniLM-L6-v2)
    - @octokit/rest v22.0.0 for GitHub API integration
    - Additional tools: Axios, Dayjs, Lodash, PapaParse, PDF-Parse, ShellJS, Quick-LRU (Remove any files using Date-fns with Dayjs)

### 🎯 **CORE DEVELOPMENT PRINCIPLES**

#### **1. Multi-Agent System Patterns**
```typescript
// Agent creation follows strict pattern from supervisorAgent.ts
const agent = new Agent({
  name: "SpecializedWorker",
  purpose: "Specific domain task handling",
  instructions: workerPrompts.generate("agentType")(),
  llm: new VercelAIProvider(),
  model: google('gemini-2.5-flash-preview-05-20'),
  providerOptions: {
    google: {
      thinkingConfig: {
        thinkingBudget: 0,      // All agents use 0 thinking budget
        includeThoughts: false,
      },
      responseModalities: ["TEXT", "IMAGE"],
    } satisfies GoogleGenerativeAIProviderOptions,
  },
  tools: [...specializedTools],
  memory: createWorkerMemory(agentType),
  hooks: createWorkerHooks(agentType),
});

// Memory isolation per agent with LibSQL
const createWorkerMemory = (agentType: string) => {
  return new LibSQLStorage({
    url: `file:./.voltagent/${agentType}-memory.db`,
    tablePrefix: `${agentType}_memory`,
    storageLimit: agentType === 'supervisor' ? 500 : 200,
    debug: env.NODE_ENV === "development"
  });
};
```

#### **2. Delegation & Coordination**
```typescript
// Supervisor delegates via subAgents property - NO delegate_task tool
const supervisorAgent = new Agent({
  name: "SupervisorAgent", 
  subAgents: [
    workers.systemInfo,    // System diagnostics
    workers.fileOps,       // File operations
    workers.git,           // Git & GitHub operations
    workers.browser,       // Playwright browser automation
    workers.coding,        // Code execution & analysis
    workers.debug,         // Debug & security analysis
    workers.research,      // Web search & scraping
    workers.knowledgeBase, // Document management
    workers.data,          // Data processing & CSV
    workers.cloud,         // Docker & deployment
  ],
  // ... other config
});

// Context tracking using Symbol-based keys for type safety
const CONTEXT_KEYS = {
  SESSION_ID: Symbol("sessionId"),
  DELEGATION_ID: Symbol("delegationId"),
  WORKFLOW_ID: Symbol("workflowId"),
  AGENT_TYPE: Symbol("agentType"),
  START_TIME: Symbol("startTime"),
} as const;

context.userContext.set(CONTEXT_KEYS.SESSION_ID, sessionId);
context.userContext.set(CONTEXT_KEYS.AGENT_TYPE, agentType);
```

#### **3. Identifier Generation Standard**
```typescript
// ALWAYS use AI SDK's generateId for unique IDs
import { generateId } from 'ai';

const sessionId = `session-${generateId()}`;
const delegationId = `delegation-${generateId()}`;
const taskId = `${agentType}-task-${generateId()}`;
```

#### **4. SupervisorRetriever Integration**
```typescript
// Supervisor uses SupervisorRetriever for semantic context storage
const retriever = createSupervisorRetriever({
  maxResults: 10,
  defaultMinScore: 1,
  storeMaxSize: 1000,
  searchCacheSize: 200,
  toolName: "supervisor_search",
  toolDescription: "Fetch recent supervisor context with in-memory LRU caching",
});

// Embeddings using @xenova/transformers with all-MiniLM-L6-v2 model
await retriever.initEmbedder();
```

### 🔒 **TYPE SAFETY & VALIDATION**

#### **Zod Schema Patterns**
```typescript
// ALL data structures MUST use Zod validation
import { z } from 'zod';

// Tool parameter schemas
const ToolParameterSchema = z.object({
  input: z.string().min(1),
  agentType: z.enum(['systemInfo', 'fileOps', 'git', 'coding', 'browser', 'research', 'knowledgeBase', 'data', 'cloud']),
  priority: z.enum(['high', 'medium', 'low']).default('medium'),
    options: z.object({
      format: z.enum(['json', 'text']).default('json')
    }).optional()
  }),
  execute: async ({ input, options }, { agent }) => {
    try {
      // Tool implementation with validation
      const processed = await processInput(input, options);
      
      // ALWAYS return string for tool output
      return typeof processed === 'string' 
        ? processed 
        : JSON.stringify(processed);
    } catch (error) {
      logger.error(`Tool ${tool.name} failed`, { 
        error: error.message,
        input: input.substring(0, 100) 
      });
      throw error;
    }
  }
});
```

#### **Tool Categories & Organization**
- **Calculator Tools**: `calculator.ts` (calculatorTool, statisticsAnalysisTool)
- **DateTime Tools**: `datetime.ts` (dateTimeTool)
- **Git Tools**: `gitTool.ts`, `enhancedGitTool.ts` (using `simple-git` and `isomorphic-git`)
- **GitHub Tools**: `githubTool.ts` (using `@octokit/rest`)
- **Coding Tools**: `codingTools.ts` (file ops, code execution, sandboxedCodeExecutorTool)
- **Web Tools**: `webBrowser.ts`, `enhancedWebBrowser.ts` (Cheerio, DuckDuckGo, secureWebProcessorTool)
- **Playwright Tools**: `src/tools/playwright/` (browser automation tools)
- **Data Tools**: `dataTools.ts` (CSV processing with `papaparse`, `json-2-csv`)
- **Cloud Tools**: `cloudTools.ts` (Docker, deployment)
- **Knowledge Tools**: `knowledgeBaseTools.ts` (document management, vector storage)
- **MCP Tools**: `mcp.ts` (filesystem, jsSandbox, docker, github, git, memory, postgres, browser)
- **Prompt Management Tools**: `promptManagementTools.ts`, `promptManagerToolkit.ts`
- **System Information Tools**: `systemInfo.ts` (systemInfoTool)
- **Debugging Tools**: `debugTools.ts`
- **Composite Tools**: `compositeTools.ts`
- **Weather Tools**: `weather.ts`

### 📊 **MONITORING & OBSERVABILITY**

#### **Structured Logging Pattern**
```typescript
// Use project logger, NOT console.log
import { logger } from '../config/logger.js';

// Agent lifecycle logging
logger.info(`[${agent.name}] Task delegation initiated`, {
  sessionId: context.userContext.get("sessionId"),
  delegationId: context.userContext.get("delegationId"),
  workflowId: context.userContext.get("workflowId"),
  operationId: context.operationId,
  agentType,
  timestamp: new Date().toISOString()
});

// Error logging with context
logger.error(`[${agent.name}] Operation failed`, {
  error: error instanceof Error ? error.message : String(error),
  stack: error instanceof Error ? error.stack : undefined,
  context: { agentType, taskId, sessionId }
});
```

#### **Hook-Based Monitoring**
```typescript
// ALL agents must implement comprehensive hooks
const hooks = createWorkerHooks(agentType);

const createWorkerHooks = (agentType: string) => createHooks({
  onStart: async ({ agent, context }) => {
    const taskId = `${agentType}-task-${generateId()}`;
    const sessionId = `${agentType}-${generateId()}`;
    
    context.userContext.set("taskId", taskId);
    context.userContext.set("sessionId", sessionId);
    context.userContext.set("agentType", agentType);
    context.userContext.set("startTime", Date.now());
    
    logger.info(`[${agent.name}] Specialized task started`, {
      taskId, sessionId, agentType, operationId: context.operationId
    });
  },
  onEnd: async ({ agent, output, error, context }) => {
    const duration = Date.now() - context.userContext.get("startTime");
    // Comprehensive completion logging with performance metrics
  },
  onToolStart: async ({ tool, context }) => {
    context.userContext.set(`toolStart-${tool.name}`, Date.now());
  },
  onToolEnd: async ({ tool, output, error, context }) => {
    const toolDuration = Date.now() - context.userContext.get(`toolStart-${tool.name}`);
    // Tool execution monitoring with anomaly detection
  }
});
```

### 🔄 **MEMORY & CONTEXT MANAGEMENT**

#### **Memory Isolation Strategy**
```typescript
// Each agent type gets isolated memory
const createWorkerMemory = (agentType: string) => {
  return new LibSQLStorage({
    url: `file:./.voltagent/${agentType}-memory.db`,
    tablePrefix: `${agentType}_memory`,
    storageLimit: agentType === 'supervisor' ? 500 : 200,
    debug: env.NODE_ENV === "development"
  });
};
```

#### **Context Retrieval Pattern**
```typescript
// Supervisor retrieval for delegation context
const retriever = createSupervisorRetriever({
  maxResults: 15,
  storeMaxSize: 1000,
  searchCacheSize: 200
});

// Add delegation context for future retrieval
retriever.addDelegationContext({
  agentType,
  task: taskDescription,
  result: result.substring(0, 500),
  taskId: delegationId,
  workflowId,
  success: !error,
  duration: Date.now() - startTime
});
```

### 🌐 **ENVIRONMENT & CONFIGURATION**

#### **Environment Variables Pattern**
```typescript
// ALL configs via environment variables
import { env } from '../config/environment.js';

// Never hardcode sensitive values
const apiKey = env.GOOGLE_AI_API_KEY;
const databaseUrl = env.DATABASE_URL || "file:./.voltagent/default.db";

// Validate environment on startup
const envSchema = z.object({
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
  GOOGLE_AI_API_KEY: z.string().min(1),
  PORT: z.coerce.number().default(3000),
  LOG_LEVEL: z.enum(['debug', 'info', 'warn', 'error']).default('info')
});
```

### ⚡ **PERFORMANCE OPTIMIZATION**

#### **Memory Limits & Caching**
```typescript
// Supervisor configuration
const SUPERVISOR_CONFIG = {
  MEMORY: {
    STORAGE_LIMIT: 500,
    WORKER_STORAGE_LIMIT: 200,
  },
  RETRIEVER: {
    MAX_RESULTS: 15,
    STORE_MAX_SIZE: 1000,
    SEARCH_CACHE_SIZE: 200,
  },
  MODELS: {
    THINKING_BUDGET: 0,      
    WORKER_THINKING_BUDGET: 0, 
  }
};
```

#### **React State Management (if UI components)**
```typescript
// ALWAYS use immutable updates
const [state, setState] = useState(initialState);

// Correct immutable update
setState(prevState => ({
  ...prevState,
  agents: {
    ...prevState.agents,
    [agentId]: { ...prevState.agents[agentId], status: 'active' }
  }
}));
```

### 📚 **DOCUMENTATION STANDARDS**

#### **TSDoc for ALL Exports**
```typescript
/**
 * Creates a specialized worker agent for specific domain tasks.
 * 
 * @param agentType - The type of specialized worker to create
 * @param tools - Array of tools specific to this worker's domain
 * @param memory - Optional memory storage, defaults to agent-specific storage
 * @returns Configured worker agent ready for delegation
 * 
 * @example
 * ```typescript
 * const gitWorker = createWorkerAgent('git', [gitTools], gitMemory);
 * ```
 * 
 * @throws {AgentCreationError} When required tools are missing
 */
export const createWorkerAgent = (
  agentType: string,
  tools: Tool[],
  memory?: LibSQLStorage
): Agent => {
  // Implementation
};
```

### 🚫 **ANTI-PATTERNS TO AVOID**

#### **Memory & Context**
- ❌ Sharing memory storage between agents
- ❌ Using global variables for agent state
- ❌ Hardcoding agent capabilities or tool lists

#### **Error Handling**
- ❌ Using `any` type instead of proper error types
- ❌ Swallowing errors without logging
- ❌ Not validating inputs with Zod schemas

#### **Performance**
- ❌ Creating new agents in hot paths
- ❌ Not setting thinking budgets appropriately
- ❌ Ignoring memory limits and cache sizes

#### **Tools & Delegation**
- ❌ Tools returning non-string outputs
- ❌ Direct agent-to-agent communication (use delegation)
- ❌ Not using the established tool development pattern

### 🔄 **DEPENDENCY MANAGEMENT**

**Package Manager**: ALWAYS use `npm` (never yarn or pnpm)
```bash
# Adding dependencies
npm install @new/package
npm install -D @dev/package

# Project uses these core dependencies (versions from package.json as of 2025-06-10):
# - @voltagent/core: ^0.1.30
# - @voltagent/vercel-ai: ^0.1.9
# - @ai-sdk/google: ^1.2.19
# - ai: ^4.3.16
# - zod: 3.25.56 
# - typescript: ^5.8.3
# - playwright: ^1.52.0
# - simple-git: ^3.28.0
# - cheerio: ^1.0.0
# - @xenova/transformers: ^2.17.2
# - eslint: ^9.28.0
# - tsx: ^4.19.4 (for development)
# - Other notable dependencies: @supabase/supabase-js, @pinecone-database/pinecone, isomorphic-git, @octokit/rest, various @opentelemetry packages.
```

### 🎯 **CODE GENERATION GUIDELINES**

#### **Generated Code Comments**
```typescript
// Generated on 2025-01-15 - Multi-agent calculator worker
export const createCalculatorAgent = (): Agent => {
  // TODO: 2025-01-15 - Add statistics analysis capabilities
  return new Agent({
    // Implementation
  });
};
```

#### **Integration Checklist**
- ✅ Agent properly registered in VoltAgent configuration
- ✅ Memory storage isolated and configured  
- ✅ Hooks implemented for monitoring
- ✅ Tools follow established patterns
- ✅ Error handling with try-catch blocks
- ✅ Zod validation for all inputs
- ✅ TSDoc documentation for exports
- ✅ Logging with structured context

This TypeScript configuration ensures AI-Volt maintains its sophisticated multi-agent architecture while following cutting-edge development practices for reliability, performance, and maintainability.